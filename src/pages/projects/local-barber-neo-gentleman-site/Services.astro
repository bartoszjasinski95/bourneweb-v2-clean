---
const { id = "services" } = Astro.props;
---

<section class="bm-services" id={id} aria-label="Prices & Services">
  <div class="bm-services__bg" aria-hidden="true">
    <div class="bm-services__bgWord bm-leftWord" data-bg-left>GROOMING</div>
    <div class="bm-services__bgWord bm-centerWord" data-bg-center>BARBERING</div>
    <div class="bm-services__bgWord bm-rightWord" data-bg-right>SPA &amp; MASSAGE</div>
  </div>

  <div class="bm-services__inner">
    <!-- ✅ Header like GALLERY -->
    <header class="bm-gal__head">
      <div>
        <p class="bm-gal__kicker">PRICES &amp; SERVICES.</p>
        <h2 class="bm-gal__title">Pick your service</h2>
        <p class="bm-gal__sub">Swipe the circle or tap arrows — prices update live.</p>
      </div>
    </header>

    <div class="bm-services__stage">
      <button class="bm-arrow bm-arrow--prev" type="button" aria-label="Previous category" data-svc-prev>
        <span aria-hidden="true">←</span>
      </button>

      <div class="bm-circle" role="img" aria-label="Service preview image" data-svc-circle></div>

      <button class="bm-arrow bm-arrow--next" type="button" aria-label="Next category" data-svc-next>
        <span aria-hidden="true">→</span>
      </button>
    </div>

    <div class="bm-services__bottom">
      <div class="bm-services__prices" aria-label="Service price list">
        <div class="bm-priceGrid" data-svc-list>
          <!-- JS fills list -->
        </div>
      </div>

      <!-- Social proof under prices -->
      <div class="bm-services__mini" aria-label="Social proof">
        <div class="bm-mini__badge">+10%</div>
        <p class="bm-mini__text">
          Most of our first-time clients book again within 30 days. Clean fades. Sharp beards. Zero drama.
        </p>
      </div>
    </div>
  </div>

  <script is:inline>
    (function () {
      const root = document.currentScript?.closest(".bm-services");
      if (!root) return;

      const data = [
        {
          key: "barbering",
          left: "GROOMING",
          center: "BARBERING",
          right: "SPA & MASSAGE",
          img: "https://images.unsplash.com/photo-1599351431618-3174d19c93a5?auto=format&fit=crop&w=1400&q=80",
          items: [
            ["Men’s haircut", "£22"],
            ["Men’s haircut “Admiral”", "£26"],
            ["Haircut + beard", "£30"],
            ["Skin fade", "£28"],
            ["Children’s haircut", "£17"],
            ["Beard care (shape)", "£7"],
            ["Beard colouring", "£15"],
            ["Shaving (regular)", "£12"],
            ["Hair treatments", "£7–£15"],
          ],
        },
        {
          key: "grooming",
          left: "BARBERING",
          center: "GROOMING",
          right: "SPA & MASSAGE",
          img: "https://images.unsplash.com/photo-1517832606299-7ae9b720a186?auto=format&fit=crop&w=1400&q=80",
          items: [
            ["Beard trim", "£14"],
            ["Hot towel shave", "£18"],
            ["Beard sculpt + line-up", "£16"],
            ["Eyebrows", "£6"],
            ["Nose wax", "£8"],
            ["Face cleanse", "£10"],
            ["Black mask", "£12"],
            ["Head massage", "£10"],
            ["Hair wash + style", "£8"],
          ],
        },
        {
          key: "spa",
          left: "GROOMING",
          center: "SPA & MASSAGE",
          right: "BARBERING",
          img: "https://images.unsplash.com/photo-1519741497674-611481863552?auto=format&fit=crop&w=1400&q=80",
          items: [
            ["Neck & shoulders (15m)", "£15"],
            ["Relax massage (30m)", "£28"],
            ["Full face treatment", "£22"],
            ["Steam towel finish", "£8"],
            ["Scalp detox", "£16"],
            ["Beard spa ritual", "£20"],
            ["Premium combo", "£42"],
            ["Student discount", "–10%"],
            ["Gift card", "from £25"],
          ],
        },
      ];

      let i = 0;

      const leftEl = root.querySelector("[data-bg-left]");
      const centerEl = root.querySelector("[data-bg-center]");
      const rightEl = root.querySelector("[data-bg-right]");
      const circleEl = root.querySelector("[data-svc-circle]");
      const listEl = root.querySelector("[data-svc-list]");
      const prev = root.querySelector("[data-svc-prev]");
      const next = root.querySelector("[data-svc-next]");

      function flash() {
        root.style.setProperty("--bm-svc-flash", "1");
        setTimeout(() => root.style.setProperty("--bm-svc-flash", "0"), 140);
      }

      function render(idx) {
        const d = data[idx];
        if (leftEl) leftEl.textContent = d.left;
        if (centerEl) centerEl.textContent = d.center;
        if (rightEl) rightEl.textContent = d.right;

        if (circleEl) circleEl.setAttribute("aria-label", `Service preview: ${d.center}`);

        if (circleEl) {
          circleEl.style.backgroundImage =
            `radial-gradient(700px 520px at 35% 30%, rgba(199,162,106,.18), transparent 60%),
             url("${d.img}")`;
        }

        if (listEl) {
          listEl.innerHTML = "";
          d.items.forEach(([name, price]) => {
            const row = document.createElement("div");
            row.className = "bm-priceRow";

            const nameEl = document.createElement("span");
            nameEl.className = "bm-priceRow__name";
            nameEl.textContent = name;

            const dotsEl = document.createElement("span");
            dotsEl.className = "bm-priceRow__dots";
            dotsEl.setAttribute("aria-hidden", "true");

            const priceEl = document.createElement("span");
            priceEl.className = "bm-priceRow__price";
            priceEl.textContent = price;

            row.appendChild(nameEl);
            row.appendChild(dotsEl);
            row.appendChild(priceEl);

            listEl.appendChild(row);
          });
        }
      }

      function step(dir) {
        i = (i + dir + data.length) % data.length;
        flash();
        render(i);
      }

      prev?.addEventListener("click", () => step(-1));
      next?.addEventListener("click", () => step(1));

      // Swipe: scoped + direction lock + iOS-safety
      let startX = 0;
      let startY = 0;
      let dx = 0;
      let dy = 0;
      let dragging = false;
      let axis = null; // "x" | "y" | null

      const THRESH_LOCK = 8;
      const THRESH_SWIPE = 34;

      function begin(x, y) {
        dragging = true;
        axis = null;
        startX = x;
        startY = y;
        dx = 0;
        dy = 0;
      }

      function move(x, y, ev) {
        if (!dragging) return;
        dx = x - startX;
        dy = y - startY;

        if (!axis) {
          if (Math.hypot(dx, dy) < THRESH_LOCK) return;
          axis = Math.abs(dx) > Math.abs(dy) ? "x" : "y";
          if (axis === "x") root.classList.add("is-swipeX");
        }

        if (axis === "x") {
          ev?.preventDefault?.();
        }
      }

      function end() {
        if (!dragging) return;
        dragging = false;

        if (axis === "x") {
          root.classList.remove("is-swipeX");
          const horiz = Math.abs(dx);
          const vert = Math.abs(dy);

          if (horiz > THRESH_SWIPE && horiz > vert * 1.2) {
            step(dx > 0 ? -1 : 1);
          }
        }

        axis = null;
      }

      if (circleEl) {
        circleEl.addEventListener("pointerdown", (e) => {
          begin(e.clientX, e.clientY);
          circleEl.setPointerCapture?.(e.pointerId);
        });

        circleEl.addEventListener("pointermove", (e) => move(e.clientX, e.clientY, e));
        circleEl.addEventListener("pointerup", end);
        circleEl.addEventListener("pointercancel", end);
        circleEl.addEventListener("lostpointercapture", end);

        if (!("PointerEvent" in window)) {
          circleEl.addEventListener("touchstart", (e) => {
            const t = e.touches[0];
            if (!t) return;
            begin(t.clientX, t.clientY);
          }, { passive: true });

          circleEl.addEventListener("touchmove", (e) => {
            const t = e.touches[0];
            if (!t) return;
            move(t.clientX, t.clientY, e);
          }, { passive: false });

          circleEl.addEventListener("touchend", end, { passive: true });
          circleEl.addEventListener("touchcancel", end, { passive: true });
        }
      }

      render(i);
    })();
  </script>
</section>
