---
import "./_booking.css";
---

<section class="bm-book" id="book" aria-label="Booking">
  <div class="bm-book__wrap">
    <header class="bm-book__head">
      <p class="bm-book__kicker">BOOK ONLINE</p>
      <h2 class="bm-book__title">Pick a service. Slide a time. Done.</h2>
      <p class="bm-book__sub">No app. No account. Pay at the shop.</p>
    </header>

    <div class="bm-bookWidget" aria-label="Booking widget" data-bm-book-widget>
      <!-- LEFT: service + day + time -->
      <div class="bm-bookWidget__left" aria-label="Service and time picker">
        <div class="bm-booking__top">
          <div class="bm-booking__title">Step 1/3 — Choose a service</div>
          <div class="bm-booking__pill">Open 10:00–20:00</div>
        </div>

        <div class="bm-chips" aria-label="Popular services">
          <button class="bm-chip" type="button" data-bm-service="skinfade">
            Skin fade <strong>£28</strong>
          </button>
          <button class="bm-chip" type="button" data-bm-service="haircutbeard">
            Haircut + beard <strong>£30</strong>
          </button>
          <button class="bm-chip" type="button" data-bm-service="hottowel">
            Hot towel shave <strong>£18</strong>
          </button>
        </div>

        <div class="bm-booking__top bm-booking__top--tight" aria-label="Day toggle">
          <div class="bm-booking__title bm-booking__title--sm">Step 2/3 — Pick a day</div>

          <div class="bm-dayTabs" role="tablist" aria-label="Day tabs">
            <button class="bm-dayTab is-active" type="button" role="tab" aria-selected="true" data-bm-day="today">
              Today
            </button>
            <button class="bm-dayTab" type="button" role="tab" aria-selected="false" data-bm-day="tomorrow">
              Tomorrow
            </button>
          </div>
        </div>

        <div class="bm-slotTop">
          <span class="bm-slotTop__k">Times</span>
          <span class="bm-slotTop__soft">Choose a slot</span>
        </div>

        <div class="bm-timeRail" aria-label="Time picker">
          <button class="bm-railBtn" type="button" data-bm-rail-left aria-label="Scroll left">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M15 18l-6-6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>

          <div class="bm-timeCarousel" aria-label="Available times">
            <div class="bm-timeCarousel__track" data-bm-track></div>
            <div class="bm-timeTimeline" aria-hidden="true"><span class="bm-timeTimeline__thumb"></span></div>
          </div>

          <button class="bm-railBtn" type="button" data-bm-rail-right aria-label="Scroll right">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M9 6l6 6-6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>

        <div class="bm-empty" data-bm-empty hidden>
          <div class="bm-empty__title">No slots today.</div>
          <div class="bm-empty__sub">Try tomorrow — fresh canvas, same sharp fade.</div>
          <button class="bm-empty__btn" type="button" data-bm-show-tomorrow>Show tomorrow</button>
        </div>

        <p class="bm-bookHint">Cancel anytime · Pay at the shop</p>
      </div>

      <!-- RIGHT: receipt + details + single CTA -->
      <form class="bm-bookWidget__right" aria-label="Booking form" data-bm-form>
        <div class="bm-formTop">
          <div>
            <div class="bm-formTop__title">Step 3/3 — Your details</div>
            <p class="bm-formTop__sub">We’ll text to confirm. No marketing.</p>
          </div>

          <button class="bm-change" type="button" data-bm-change>
            Change
          </button>
        </div>

        <!-- RECEIPT -->
        <div class="bm-receipt" aria-label="Booking summary">
          <div class="bm-receipt__head">
            <span class="bm-receipt__brand">NEO GENTLEMAN</span>
            <span class="bm-receipt__meta" data-bm-receipt-range>—</span>
          </div>

          <div class="bm-receipt__rows">
            <div class="bm-receipt__row">
              <span class="bm-receipt__label">Service</span>
              <span class="bm-receipt__value" data-bm-r-service>—</span>
            </div>
            <div class="bm-receipt__row">
              <span class="bm-receipt__label">Duration</span>
              <span class="bm-receipt__value" data-bm-r-duration>—</span>
            </div>
            <div class="bm-receipt__row">
              <span class="bm-receipt__label">Price</span>
              <span class="bm-receipt__value" data-bm-r-price>—</span>
            </div>
          </div>

          <div class="bm-receipt__total">
            <span class="bm-receipt__label">Total</span>
            <span class="bm-receipt__value" data-bm-r-total>—</span>
          </div>
        </div>

        <!-- hidden values (for real backend later) -->
        <input type="hidden" name="service" value="" data-bm-hidden-service />
        <input type="hidden" name="time" value="" data-bm-hidden-time />
        <input type="hidden" name="day" value="today" data-bm-hidden-day />

        <label class="bm-field">
          <span class="bm-field__label">Phone <span class="bm-field__req">(required)</span></span>
          <input
            class="bm-input"
            name="phone"
            autocomplete="tel"
            inputmode="tel"
            placeholder="+44 7xxx xxx xxx"
            required
            data-bm-phone
          />
          <span class="bm-field__hint" data-bm-phone-hint>We’ll only use this to confirm your slot.</span>
        </label>

        <label class="bm-field">
          <span class="bm-field__label">Name <span class="bm-field__opt">(optional)</span></span>
          <input class="bm-input" name="name" autocomplete="name" placeholder="Bartek (if you feel fancy)" />
        </label>

        <label class="bm-field">
          <span class="bm-field__label">Notes <span class="bm-field__opt">(optional)</span></span>
          <textarea
            class="bm-input bm-input--area"
            name="notes"
            rows="3"
            placeholder="Beard trim? Skin fade length? Any allergies?"
          ></textarea>
        </label>

        <div class="bm-trust" aria-label="Trust info">
          <div class="bm-trust__item">Avg confirmation: <strong>2–5 min</strong></div>
          <div class="bm-trust__item">⭐ <strong>4.9</strong> • <strong>1,200+</strong> cuts</div>
          <div class="bm-trust__item">Pay at the shop • Cancel anytime</div>
        </div>

        <div class="bm-formActions" data-bm-actions>
          <button class="bm-mainCta" type="submit" data-bm-cta disabled>
            Choose a service
            <span class="bm-mainCta__sheen" aria-hidden="true"></span>
          </button>

          <p class="bm-privacy">
            We’ll text to confirm. No marketing. <a href="#" class="bm-privacy__link">Privacy</a>
          </p>
        </div>

        <div class="bm-toast" data-bm-toast aria-live="polite" hidden></div>
      </form>
    </div>
  </div>

  <script is:inline>
    (function () {
      const widget = document.querySelector("[data-bm-book-widget]");
      if (!widget) return;

      // HOURS
      const START = 10 * 60;
      const END = 20 * 60;
      const STEP = 15;

      const pad = (n) => String(n).padStart(2, "0");
      const fmt = (mins) => `${pad(Math.floor(mins / 60))}:${pad(mins % 60)}`;

      const toMins = (hhmm) => {
        const [h, m] = hhmm.split(":").map(Number);
        return h * 60 + m;
      };

      const addMins = (hhmm, add) => fmt(toMins(hhmm) + add);

      const allTimes = [];
      for (let m = START; m < END; m += STEP) allTimes.push(fmt(m));

      function roundUpToStep(mins) {
        return Math.ceil(mins / STEP) * STEP;
      }

      function nextAvailableToday() {
        const now = new Date();
        const cur = now.getHours() * 60 + now.getMinutes();
        const rounded = roundUpToStep(cur);
        if (rounded < START) return fmt(START);
        if (rounded >= END) return null;
        return fmt(rounded);
      }

      // SERVICES
      const services = {
        skinfade: { label: "Skin fade", mins: 50, price: 28 },
        haircutbeard: { label: "Haircut + beard", mins: 60, price: 30 },
        hottowel: { label: "Hot towel shave", mins: 30, price: 18 },
      };

      // DOM
      const leftTitle = widget.querySelector(".bm-booking__title");
      const track = widget.querySelector("[data-bm-track]");
      const railL = widget.querySelector("[data-bm-rail-left]");
      const railR = widget.querySelector("[data-bm-rail-right]");
      const timeline = widget.querySelector(".bm-timeTimeline");
      const timelineThumb = widget.querySelector(".bm-timeTimeline__thumb");

      const chipBtns = Array.from(widget.querySelectorAll("[data-bm-service]"));
      const dayTabs = Array.from(widget.querySelectorAll("[data-bm-day]"));
      const empty = widget.querySelector("[data-bm-empty]");
      const showTomorrowBtn = widget.querySelector("[data-bm-show-tomorrow]");

      const form = widget.querySelector("[data-bm-form]");
      const cta = widget.querySelector("[data-bm-cta]");
      const actions = widget.querySelector("[data-bm-actions]");
      const toast = widget.querySelector("[data-bm-toast]");

      const phone = widget.querySelector("[data-bm-phone]");
      const phoneHint = widget.querySelector("[data-bm-phone-hint]");

      const changeBtn = widget.querySelector("[data-bm-change]");

      const rRange = widget.querySelector("[data-bm-receipt-range]");
      const rService = widget.querySelector("[data-bm-r-service]");
      const rDuration = widget.querySelector("[data-bm-r-duration]");
      const rPrice = widget.querySelector("[data-bm-r-price]");
      const rTotal = widget.querySelector("[data-bm-r-total]");

      const hiddenSvc = widget.querySelector("[data-bm-hidden-service]");
      const hiddenTime = widget.querySelector("[data-bm-hidden-time]");
      const hiddenDay = widget.querySelector("[data-bm-hidden-day]");

      // STATE
      let activeServiceKey = "";
      let activeDay = "today";
      let activeTime = "";

      // Helpers
      function money(n) { return `£${n}`; }

      function dayLabel(day) { return day === "today" ? "Today" : "Tomorrow"; }

      function rangeLabel() {
        if (!activeTime || !activeServiceKey) return "—";
        const s = services[activeServiceKey];
        const end = addMins(activeTime, s.mins);
        return `${dayLabel(activeDay)} • ${activeTime}–${end}`;
      }

      function renderReceipt() {
        if (!activeServiceKey) {
          rService.textContent = "—";
          rDuration.textContent = "—";
          rPrice.textContent = "—";
          rTotal.textContent = "—";
          rRange.textContent = "—";
          return;
        }
        const s = services[activeServiceKey];
        rService.textContent = s.label;
        rDuration.textContent = `${s.mins} min`;
        rPrice.textContent = money(s.price);
        rTotal.textContent = money(s.price);
        rRange.textContent = rangeLabel();
      }

      function isPhoneValid(raw) {
        const digits = (raw || "").replace(/\D/g, "");
        // accept 10–13 digits (UK-ish incl country)
        return digits.length >= 10 && digits.length <= 13;
      }

      function formatUKPhone(raw) {
        let v = (raw || "").trim();
        // keep + at start, remove other junk
        v = v.replace(/[^\d+]/g, "");
        if (v.includes("+")) {
          v = "+" + v.replace(/\+/g, "").replace(/[^\d]/g, "");
        }
        const digits = v.replace(/\D/g, "");
        const hasPlus = v.startsWith("+");

        // basic pretty spacing: +44 7xxx xxx xxx OR 07xxx xxx xxx
        if (hasPlus) {
          // +44xxxxxxxxxxx
          if (digits.startsWith("44") && digits.length >= 12) {
            const rest = digits.slice(2);
            const a = rest.slice(0, 4);
            const b = rest.slice(4, 7);
            const c = rest.slice(7, 10);
            const d = rest.slice(10, 13);
            return `+44 ${a}${b ? " " + b : ""}${c ? " " + c : ""}${d ? " " + d : ""}`.trim();
          }
          return "+" + digits;
        } else {
          // 0xxxxxxxxxx
          const a = digits.slice(0, 5);
          const b = digits.slice(5, 8);
          const c = digits.slice(8, 11);
          return `${a}${b ? " " + b : ""}${c ? " " + c : ""}`.trim();
        }
      }

      function updateCTA() {
        // step titles
        if (leftTitle) {
          leftTitle.textContent = activeServiceKey
            ? "Step 2/3 — Pick a time"
            : "Step 1/3 — Choose a service";
        }

        const svcOk = !!activeServiceKey;
        const timeOk = !!activeTime;
        const phoneOk = isPhoneValid(phone.value);

        if (!svcOk) {
          cta.textContent = "Choose a service";
          cta.disabled = true;
        } else if (!timeOk) {
          cta.textContent = "Pick a time";
          cta.disabled = true;
        } else if (!phoneOk) {
          cta.textContent = "Add your phone to confirm";
          cta.disabled = true;
        } else {
          cta.textContent = `Confirm ${activeTime} — ${services[activeServiceKey].label}`;
          cta.disabled = false;
        }

        // hidden values
        hiddenSvc.value = activeServiceKey || "";
        hiddenTime.value = activeTime || "";
        hiddenDay.value = activeDay;

        // receipt
        renderReceipt();

        // hint tone
        if (phoneHint) {
          if (phone.value && !phoneOk) {
            phoneHint.textContent = "That number looks short — add area code.";
            phoneHint.classList.add("is-warn");
          } else {
            phoneHint.textContent = "We’ll only use this to confirm your slot.";
            phoneHint.classList.remove("is-warn");
          }
        }
      }

      function setActiveService(key) {
        activeServiceKey = key;

        chipBtns.forEach((b) => b.classList.toggle("is-active", b.getAttribute("data-bm-service") === key));

        // rerender times with ranges + auto-pick next available
        autoPickTime();
        updateCTA();
      }

      function setActiveDay(day) {
        activeDay = day;
        dayTabs.forEach((t) => {
          const is = t.getAttribute("data-bm-day") === day;
          t.classList.toggle("is-active", is);
          t.setAttribute("aria-selected", is ? "true" : "false");
        });

        autoPickTime();
        updateCTA();
      }

      function timesForDay(day) {
        if (day === "tomorrow") return allTimes.slice();
        const next = nextAvailableToday();
        if (!next) return [];
        const startIdx = allTimes.indexOf(next);
        return startIdx >= 0 ? allTimes.slice(startIdx) : allTimes.slice();
      }

      function timeEndsAt(t) {
        if (!activeServiceKey) return "";
        const s = services[activeServiceKey];
        return addMins(t, s.mins);
      }

      function renderTimes() {
        const times = timesForDay(activeDay);
        track.innerHTML = "";

        if (times.length === 0) {
          empty.hidden = false;
          activeTime = "";
          updateCTA();
          return;
        }

        empty.hidden = true;

        const nextLabelTime = (activeDay === "today") ? nextAvailableToday() : times[0];

        times.forEach((t, idx) => {
          const b = document.createElement("button");
          b.type = "button";
          b.className = "bm-timeChip" + (t === activeTime ? " is-active" : "");
          b.setAttribute("data-time", t);

          const end = timeEndsAt(t);
          const hasSvc = !!activeServiceKey;

          const badge = (t === nextLabelTime)
            ? `<span class="bm-timeChip__badge">Next available</span>`
            : "";

          b.innerHTML = `
            ${badge}
            <span class="bm-timeChip__time">${t}</span>
            <span class="bm-timeChip__sub">${hasSvc ? `${t}–${end}` : `Select service for range`}</span>
          `;

          b.addEventListener("click", () => {
            activeTime = t;
            Array.from(track.querySelectorAll("[data-time]")).forEach((x) =>
              x.classList.toggle("is-active", x.getAttribute("data-time") === t)
            );
            updateCTA();
          });

          track.appendChild(b);
        });

        // update scroll UI
        requestAnimationFrame(() => {
          updateRail();
          updateTimeline();
          // snap to active (center-ish)
          const btn = track.querySelector(`[data-time="${activeTime}"]`);
          if (btn) btn.scrollIntoView({ behavior: "smooth", inline: "center", block: "nearest" });
        });
      }

      function autoPickTime() {
        const times = timesForDay(activeDay);
        if (times.length === 0) {
          renderTimes();
          return;
        }

        // if existing selection still valid, keep it; otherwise pick first
        if (!activeTime || !times.includes(activeTime)) {
          activeTime = times[0];
        }
        renderTimes();
      }

      function updateRail() {
        if (!track) return;
        const max = track.scrollWidth - track.clientWidth;
        const x = track.scrollLeft;
        railL.disabled = x <= 2;
        railR.disabled = x >= max - 2;
      }

      function updateTimeline() {
        if (!timeline || !timelineThumb || !track) return;
        const max = track.scrollWidth - track.clientWidth;
        const p = max <= 0 ? 0 : track.scrollLeft / max;
        timelineThumb.style.transform = `translateX(${Math.round(p * 100)}%)`;
      }

      // events
      chipBtns.forEach((btn) => {
        btn.addEventListener("click", () => setActiveService(btn.getAttribute("data-bm-service") || ""));
      });

      dayTabs.forEach((tab) => {
        tab.addEventListener("click", () => setActiveDay(tab.getAttribute("data-bm-day") || "today"));
      });

      railL.addEventListener("click", () => track.scrollBy({ left: -240, behavior: "smooth" }));
      railR.addEventListener("click", () => track.scrollBy({ left: 240, behavior: "smooth" }));

      track.addEventListener("scroll", () => {
        updateRail();
        updateTimeline();
      });

      window.addEventListener("resize", () => {
        updateRail();
        updateTimeline();
      });

      if (showTomorrowBtn) {
        showTomorrowBtn.addEventListener("click", () => setActiveDay("tomorrow"));
      }

      if (phone) {
        phone.addEventListener("input", () => {
          const cur = phone.value;
          const formatted = formatUKPhone(cur);
          if (formatted !== cur) phone.value = formatted;
          updateCTA();
        });
        phone.addEventListener("blur", updateCTA);
      }

      if (changeBtn) {
        changeBtn.addEventListener("click", () => {
          // jump attention to left picker
          widget.querySelector(".bm-bookWidget__left")?.scrollIntoView({ behavior: "smooth", block: "start" });
          chipBtns[0]?.focus({ preventScroll: true });
        });
      }

      // submit UX (demo)
      form.addEventListener("submit", (e) => {
        e.preventDefault();

        const svcOk = !!activeServiceKey;
        const timeOk = !!activeTime;
        const phoneOk = isPhoneValid(phone.value);

        if (!svcOk || !timeOk || !phoneOk) {
          updateCTA();
          return;
        }

        cta.disabled = true;
        const prev = cta.textContent;
        cta.textContent = "Sending…";

        toast.hidden = false;
        toast.textContent = "Sending request…";

        setTimeout(() => {
          toast.textContent = "Request sent. We’ll text you soon.";
          cta.textContent = prev;
          updateCTA();
          setTimeout(() => { toast.hidden = true; }, 2200);
        }, 900);
      });

      // init
      setActiveDay("today");
      updateCTA();
      renderReceipt();
      renderTimes();
      updateRail();
      updateTimeline();
    })();
  </script>
</section>
