---
const {
  id = "book",
  title = "Book your slot",
  subtitle = "Pick a service, choose a time, leave your details. Instant confirmation vibe — demo mode.",
} = Astro.props;
---

<section class="bm-book" id={id} aria-label="Booking form" data-bm-book>
  <div class="bm-book__inner">
    <header class="bm-book__head">
      <p class="bm-book__kicker">BOOKING</p>
      <h2 class="bm-book__title">{title}</h2>
      <p class="bm-book__sub">{subtitle}</p>

      <div class="bm-book__badges" aria-label="Booking benefits">
        <span class="bm-bookBadge">No app</span>
        <span class="bm-bookBadge">Free cancellation</span>
        <span class="bm-bookBadge">Takes 30 seconds</span>
      </div>
    </header>

    <!-- Single-card layout -->
    <div class="bm-book__grid">
      <div class="bm-bookCard" aria-label="Booking card">
        <form class="bm-form" data-bm-form>
          <!-- honeypot -->
          <label class="bm-hp" aria-hidden="true">
            Don’t fill this
            <input name="company" autocomplete="off" tabindex="-1" />
          </label>

          <div class="bm-form__grid">
            <div class="bm-field">
              <label class="bm-label" for="svc">Service</label>
              <div class="bm-control">
                <select id="svc" name="service" required data-bm-svc>
                  <option value="" selected disabled>Select a service</option>
                  <option value="Men’s haircut" data-dur="45" data-price="£22">Men’s haircut · 45 min · £22</option>
                  <option value="Skin fade" data-dur="50" data-price="£28">Skin fade · 50 min · £28</option>
                  <option value="Haircut + beard" data-dur="60" data-price="£30">Haircut + beard · 60 min · £30</option>
                  <option value="Hot towel shave" data-dur="30" data-price="£18">Hot towel shave · 30 min · £18</option>
                </select>
              </div>
              <p class="bm-hint" data-bm-svcHint>Pick a service to see duration.</p>
            </div>

            <div class="bm-field">
              <label class="bm-label" for="barber">Barber</label>
              <div class="bm-control">
                <select id="barber" name="barber" data-bm-barber>
                  <option value="Any" selected>Any available</option>
                  <option value="Alex">Alex (fades)</option>
                  <option value="Sam">Sam (beards)</option>
                  <option value="Jordan">Jordan (classic)</option>
                </select>
              </div>
              <p class="bm-hint">Optional. “Any” usually finds faster slots.</p>
            </div>

            <div class="bm-field">
              <label class="bm-label" for="date">Date</label>
              <div class="bm-control">
                <input id="date" name="date" type="date" required data-bm-date />
              </div>
            </div>

            <div class="bm-field">
              <label class="bm-label" for="time">Time</label>
              <div class="bm-control">
                <select id="time" name="time" required data-bm-time>
                  <option value="" selected disabled>Select time</option>
                  <option>10:00</option><option>11:10</option><option>12:20</option>
                  <option>13:30</option><option>14:40</option><option>15:50</option>
                  <option>16:10</option><option>17:20</option><option>18:10</option>
                </select>
              </div>
            </div>

            <div class="bm-field">
              <label class="bm-label" for="name">Full name</label>
              <div class="bm-control">
                <input id="name" name="name" type="text" autocomplete="name" placeholder="e.g. Michael Brown" required />
              </div>
            </div>

            <div class="bm-field">
              <label class="bm-label" for="phone">Phone</label>
              <div class="bm-control">
                <input id="phone" name="phone" type="tel" autocomplete="tel" placeholder="e.g. +44 7..." required />
              </div>
            </div>

            <div class="bm-field">
              <label class="bm-label" for="email">Email</label>
              <div class="bm-control">
                <input id="email" name="email" type="email" autocomplete="email" placeholder="you@email.com" />
              </div>
              <p class="bm-hint">Optional. We can confirm by email too.</p>
            </div>

            <div class="bm-field bm-field--full">
              <label class="bm-label" for="note">Notes</label>
              <div class="bm-control">
                <textarea id="note" name="notes" rows="3" placeholder="Anything we should know? (style reference, beard length, etc.)"></textarea>
              </div>
            </div>
          </div>

          <div class="bm-form__bottom">
            <div class="bm-summary" aria-label="Booking summary">
              <div class="bm-summary__title">Summary</div>
              <div class="bm-summary__row">
                <span class="bm-summary__k">Service</span>
                <span class="bm-summary__v" data-bm-sumSvc>—</span>
              </div>
              <div class="bm-summary__row">
                <span class="bm-summary__k">Duration</span>
                <span class="bm-summary__v" data-bm-sumDur>—</span>
              </div>
              <div class="bm-summary__row">
                <span class="bm-summary__k">Price</span>
                <span class="bm-summary__v bm-summary__price" data-bm-sumPrice>—</span>
              </div>
              <div class="bm-summary__row">
                <span class="bm-summary__k">When</span>
                <span class="bm-summary__v" data-bm-sumWhen>—</span>
              </div>
            </div>

            <div class="bm-form__cta">
              <button class="bm-submit" type="submit" data-bm-submit>
                Request booking
                <span class="bm-submit__shine" aria-hidden="true"></span>
              </button>
              <p class="bm-legal">
                By booking, you agree to our cancellation policy.
              </p>
            </div>
          </div>

          <div class="bm-toast" role="status" aria-live="polite" data-bm-toast>
            <strong>Request sent.</strong> We’ll confirm your slot shortly.
          </div>
        </form>
      </div>
    </div>
  </div>

  <script is:inline>
    (function () {
      const root = document.querySelector('[data-bm-book]');
      if (!root) return;

      const form = root.querySelector('[data-bm-form]');
      const svc = root.querySelector('[data-bm-svc]');
      const svcHint = root.querySelector('[data-bm-svcHint]');
      const date = root.querySelector('[data-bm-date]');
      const time = root.querySelector('[data-bm-time]');
      const submit = root.querySelector('[data-bm-submit]');
      const toast = root.querySelector('[data-bm-toast]');

      const sumSvc = root.querySelector('[data-bm-sumSvc]');
      const sumDur = root.querySelector('[data-bm-sumDur]');
      const sumPrice = root.querySelector('[data-bm-sumPrice]');
      const sumWhen = root.querySelector('[data-bm-sumWhen]');

      // min date = today
      try {
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        if (date) date.min = `${yyyy}-${mm}-${dd}`;
      } catch (e) {}

      function updateSummary(){
        const opt = svc && svc.selectedOptions ? svc.selectedOptions[0] : null;
        const s = opt && opt.value ? opt.value : '—';
        const dur = opt && opt.dataset && opt.dataset.dur ? `${opt.dataset.dur} min` : '—';
        const price = opt && opt.dataset && opt.dataset.price ? opt.dataset.price : '—';

        if (svcHint) svcHint.textContent = opt && opt.dataset && opt.dataset.dur
          ? `Duration: ${opt.dataset.dur} min.`
          : 'Pick a service to see duration.';

        if (sumSvc) sumSvc.textContent = s;
        if (sumDur) sumDur.textContent = dur;
        if (sumPrice) sumPrice.textContent = price;

        const d = date && date.value ? date.value : '';
        const t = time && time.value ? time.value : '';
        if (sumWhen) sumWhen.textContent = (d && t) ? `${d} · ${t}` : '—';
      }

      svc?.addEventListener('change', updateSummary);
      date?.addEventListener('change', updateSummary);
      time?.addEventListener('change', updateSummary);

      form?.addEventListener('submit', (e) => {
        e.preventDefault();

        // honeypot
        const hp = form.querySelector('input[name="company"]');
        if (hp && hp.value) return;

        if (typeof form.checkValidity === 'function' && !form.checkValidity()){
          form.reportValidity?.();
          return;
        }

        if (submit){
          submit.disabled = true;
          submit.textContent = 'Sending…';
        }

        setTimeout(() => {
          if (toast){
            toast.classList.add('is-on');
            setTimeout(() => toast.classList.remove('is-on'), 2200);
          }

          if (submit){
            submit.disabled = false;
            submit.innerHTML = 'Request booking <span class="bm-submit__shine" aria-hidden="true"></span>';
          }

          form.reset();
          updateSummary();
        }, 650);
      });

      updateSummary();
    })();
  </script>
</section>
